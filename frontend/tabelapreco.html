<!DOCTYPE html>
<html>
<head>
  <title>Tabela de Preços</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>

<div class="layout">

  <!-- SIDEBAR -->
  <div class="sidebar">
    <h2>Motoboy</h2>
    <a href="dashboard.html">Dashboard</a>
    <a href="tabelapreco.html">Tabela de Preços</a>
    <a href="clientes.html">Clientes</a>
    <a href="pedidos.html">Pedidos</a>
    <a href="#" onclick="logout()">Sair</a>
  </div>

  <!-- CONTEÚDO -->
  <div class="content">

    <div class="card">
      <h2>Cadastro de Preços por Bairro</h2>
      <p>Defina o valor da entrega por região</p>
    </div>

    <div class="card">
      <h3>Novo Bairro</h3>

      <input id="bairro" placeholder="Bairro">
      <input id="valor" placeholder="Valor" oninput="mascaraValor(this)">

      <button onclick="salvar()">Salvar Preço</button>
    </div>

    <div class="card">
      <h3>Lista de Bairros</h3>

      <table class="table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Bairro</th>
            <th>Valor</th>
          </tr>
        </thead>
        <tbody id="lista"></tbody>
      </table>
    </div>

  </div>
</div>

<script src="js/api.js"></script>
<script src="js/ui.js"></script>

<script>
function logout(){
  localStorage.removeItem("token");
  window.location.href = "index.html";
}

async function carregar(){
  const precos = await getPrecos();

  let html="";
  precos.forEach(p=>{
    html += `<tr>
      <td>${p.id}</td>
      <td>${p.bairro}</td>
      <td>R$ ${p.valor.toFixed(2)}</td>
    </tr>`;
  });

  document.getElementById("lista").innerHTML = html;
}

async function salvar(){
  const bairroVal = bairro.value.trim();
  const valorVal = valor.value.trim();

  if(!bairroVal || !valorVal){
    toast("Preencha todos os campos","erro");
    return;
  }

  await criarPreco({
    bairro: bairroVal,
    valor: converterValor(valorVal)
  });

  toast("Preço cadastrado com sucesso");

  bairro.value="";
  valor.value="";

  carregar();
}

/* máscara valor */
function mascaraValor(campo){
  let v = campo.value.replace(/\D/g,'');
  v = (v/100).toFixed(2)+'';
  v = v.replace(".",",");
  v = v.replace(/(\d)(?=(\d{3})+(?!\d))/g,'$1.');
  campo.value = 'R$ '+v;
}

/* converter para float */
function converterValor(v){
  if(!v) return 0;

  v = v.replace("R$","")
       .replace(/\./g,"")
       .replace(",",".")
       .trim();

  return parseFloat(v);
}

carregar();
</script>

</body>
</html>